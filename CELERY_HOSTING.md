# Настройка Celery на хостинге

Этот документ содержит инструкции по настройке и запуску Celery на хостинге для корректной работы периодических задач, включая ежедневное удаление заказов в 08:00 по МСК.

## Проблема

Задача `clear_orders`, которая должна удалять заказы каждое утро в 08:00 по МСК, не отрабатывает на хостинге.

## Решение

Для корректной работы Celery на хостинге необходимо настроить следующие компоненты:

1. **Celery Worker** - обрабатывает задачи
2. **Celery Beat** - планировщик, который отправляет задачи в очередь по расписанию

## Инструкции по настройке

### 1. Проверка текущего состояния

Запустите скрипт проверки состояния Celery:

```bash
./check_and_run_celery.sh
```

Этот скрипт проверит:
- Запущены ли Celery Worker и Beat
- Доступен ли Redis (необходим для работы Celery)
- Текущее время сервера и настройки часового пояса
- Задачи в расписании Celery Beat

### 2. Настройка с использованием Supervisor (рекомендуется)

Supervisor - это система управления процессами, которая обеспечивает автоматический запуск и перезапуск процессов.

1. Запустите скрипт настройки Supervisor:

```bash
./setup_celery_hosting.sh
```

2. Следуйте инструкциям, которые выведет скрипт.

### 3. Ручной запуск Celery

Если вы не используете Supervisor, вы можете запустить Celery вручную:

```bash
# Запуск Celery Worker и Beat
./run_celery.sh

# Или запустите их по отдельности
./run_celery_worker.sh
./run_celery_beat.sh
```

### 4. Тестирование задачи удаления заказов

Для проверки работы задачи удаления заказов запустите:

```bash
./test_clear_orders.sh
```

## Проверка логов

Для проверки логов Celery используйте:

```bash
# Если используется Supervisor
tail -f logs/celery_worker.log
tail -f logs/celery_beat.log

# Если запущено вручную
tail -f celery_beat.log
```

## Возможные проблемы и их решения

### 1. Ошибка ImproperlyConfigured

Если вы видите ошибку `django.core.exceptions.ImproperlyConfigured`, это означает, что Django не может найти настройки. Убедитесь, что переменная окружения `DJANGO_SETTINGS_MODULE` установлена:

```bash
export DJANGO_SETTINGS_MODULE="SoloPizza.settings"
```

Все скрипты запуска Celery (`run_celery.sh`, `run_celery_worker.sh`, `run_celery_beat.sh`) уже обновлены для установки этой переменной. Если вы используете Supervisor, убедитесь, что в конфигурационных файлах также установлена эта переменная:

```ini
environment=DJANGO_SETTINGS_MODULE="SoloPizza.settings"
```

### 2. Redis недоступен

Celery использует Redis в качестве брокера сообщений. Убедитесь, что Redis запущен и доступен:

```bash
redis-cli ping
```

Должен вернуть `PONG`. Если это не так, проверьте настройки Redis в `settings.py` и убедитесь, что Redis запущен на хостинге.

### 3. Неправильный часовой пояс

Убедитесь, что в `settings.py` установлен правильный часовой пояс:

```python
TIME_ZONE = "Europe/Moscow"
USE_TZ = True
CELERY_TIMEZONE = TIME_ZONE
```

### 4. Задача не активирована в Django Celery Beat

Проверьте, что задача активирована в административной панели Django:

1. Перейдите в админку Django
2. Откройте раздел "Periodic tasks"
3. Найдите задачу "clear-orders-every-day"
4. Убедитесь, что флажок "Enabled" включен

## Дополнительная информация

Для более подробной информации о настройке Celery см. [официальную документацию Celery](https://docs.celeryproject.org/en/stable/userguide/periodic-tasks.html).