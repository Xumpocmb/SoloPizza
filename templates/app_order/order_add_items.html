{% extends 'base.html' %}
{% load static %}


{% block styles %}
    <link rel="stylesheet" href="{% static 'css/order_detail.css' %}">
{% endblock %}

{% block main %}
    <main class="order-detail-page">
        <h1>Редактирование заказа №{{ order.id }}</h1>
        <p><a href="{% url 'app_order:order_detail_editor' order.id %}">Вернуться к редактированию заказа</a></p>
        <section class="section_order">
            <h2>Текущие товары в заказе</h2>
            <ul>
                {% for item in order.items.all %}
                    <li>
                        {{ item.item.name }} ({{ item.item_params.size.name }}, {{ item.quantity }} шт.)
                        <strong>{{ item.calculate_total_price }} руб.</strong>
                    </li>
                {% endfor %}
            </ul>

            <h2>Добавить товар</h2>
            <form method="post" action="{% url 'app_order:add_to_order' order.id %}">
                {% csrf_token %}
                {{ form.as_p }}
                <div id="addon-options"></div>
                <button class="save-changes" type="submit">Добавить</button>
            </form>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const itemSelect = document.getElementById('id_item');
            const sizeSelect = document.getElementById('id_size');
            const boardSelect = document.getElementById('id_board');
            const addonContainer = document.getElementById('addon-options');

            sizeSelect.addEventListener('change', function () {
                const sizeId = sizeSelect.value;
                loadBoards(sizeId);
                loadAddons(sizeId);
            });

            itemSelect.addEventListener('change', function () {
                const itemId = itemSelect.value;
                if (itemId) {
                    fetch(`/order/api/item-sizes/${itemId}/`)
                        .then(response => response.json())
                        .then(data => {
                            sizeSelect.innerHTML = '<option value="">Выберите размер</option>';
                            data.forEach(size => {
                                const option = document.createElement('option');
                                option.value = size.id;
                                option.textContent = size.name; // Отображаем название размера
                                sizeSelect.appendChild(option);
                            });
                        });
                } else {
                    sizeSelect.innerHTML = '<option value="">Выберите размер</option>';
                }
            });

            function loadBoards(sizeId) {
                const boardSelect = document.getElementById('id_board');
                if (sizeId) {
                    fetch(`/order/api/board-params/${sizeId}/`)
                        .then(response => response.json())
                        .then(data => {
                            boardSelect.innerHTML = '<option value="">Выберите борт</option>';
                            data.forEach(board => {
                                const option = document.createElement('option');
                                option.value = board.id;
                                option.textContent = `${board.name} (+${board.price} руб.)`;
                                boardSelect.appendChild(option);
                            });
                        });
                } else {
                    boardSelect.innerHTML = '<option value="">Борты недоступны</option>';
                }
            }

            function loadAddons(sizeId) {
                const addonContainer = document.getElementById('addon-options');
                if (sizeId) {
                    fetch(`/order/api/addon-params/${sizeId}/`)
                        .then(response => response.json())
                        .then(data => {
                            addonContainer.innerHTML = '';
                            data.forEach(addon => {
                                const label = document.createElement('label');
                                const input = document.createElement('input');
                                input.type = 'checkbox';
                                input.name = 'addons';
                                input.value = addon.id;
                                label.appendChild(input);
                                label.appendChild(document.createTextNode(`${addon.name} (+${addon.price} руб.)`));
                                addonContainer.appendChild(label);
                            });
                        });
                } else {
                    addonContainer.innerHTML = '<p>Добавки недоступны</p>';
                }
            }
        });
    </script>

{% endblock %}


