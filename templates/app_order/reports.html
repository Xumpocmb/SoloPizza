{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Отчеты - Solo Pizza{% endblock %}

{% block meta_description %}Отчеты по заказам Solo Pizza - просмотрите данные о суммах заказов по филиалам за текущий день.{% endblock %}
{% block meta_keywords %}отчеты, аналитика заказов, Solo Pizza отчеты{% endblock %}
{% block og_description %}Отчеты по заказам Solo Pizza - просмотрите данные о суммах заказов по филиалам за текущий день.{% endblock %}
{% block twitter_description %}Отчеты по заказам Solo Pizza - просмотрите данные о суммах заказов по филиалам за текущий день.{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/order_list.css' %}">
    <link rel="stylesheet" href="{% static 'css/order_statistics.css' %}">
    <style>
        .branch-statistics-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .branch-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .branch-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin: 0 10px 0;
        }

        .branch-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-title {
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .summary-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #495057;
        }

        .items-list {
            margin-top: 20px;
        }

        .item-entry {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .item-entry:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-quantity {
            color: #6c757d;
            font-size: 0.9em;
        }

        .payment-methods {
            flex: 1;
            text-align: right;
        }

        .method-item {
            display: block;
            margin-bottom: 3px;
            font-size: 0.9em;
            color: #495057;
        }

        .back-to-statistics {
            display: inline-block;
            margin-bottom: 20px;
            padding: 8px 16px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .back-to-statistics:hover {
            background-color: #5a6268;
        }
    </style>
{% endblock %}

{% block main %}
<main class="order-list-page">
    {% if breadcrumbs %}
        <div class="breadcrumbs">
            {% for crumb in breadcrumbs %}
                {% if crumb.url != '#' %}
                    <a href="{{ crumb.url }}" class="breadcrumb-link">{{ crumb.title }}</a>
                {% else %}
                    <span class="breadcrumb-current">{{ crumb.title }}</span>
                {% endif %}
                {% if not forloop.last %}
                    <span class="breadcrumb-separator">›</span>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}

    <div class="branch-statistics-container">
        <h1 class="page-title">Отчеты за {{ selected_date|date:"d.m.Y" }}</h1>

        <!-- Общая статистика -->
        <div class="branch-header">
            <h2 class="branch-name">Общая статистика</h2>

            <div class="branch-summary">
                <div class="summary-card">
                    <div class="summary-title">Количество заказов</div>
                    <div class="summary-value">{{ total_orders_count }}</div>
                </div>

                <div class="summary-card">
                    <div class="summary-title">Наличные</div>
                    <div class="summary-value">{{ total_cash|format_price }}</div>
                </div>

                <div class="summary-card">
                    <div class="summary-title">Карта</div>
                    <div class="summary-value">{{ total_card|format_price }}</div>
                </div>

                <div class="summary-card">
                    <div class="summary-title">Безнал</div>
                    <div class="summary-value">{{ total_noname|format_price }}</div>
                </div>

                <div class="summary-card">
                    <div class="summary-title">Итого</div>
                    <div class="summary-value">{{ total_amount|format_price }}</div>
                </div>
            </div>
        </div>

        {% for branch_id, branch_data in branch_statistics.items %}
            <div class="branch-header">
                <h2 class="branch-name">{{ branch_data.name }}</h2>

                <div class="branch-summary">
                    <div class="summary-card">
                        <div class="summary-title">Количество заказов</div>
                        <div class="summary-value">{{ branch_data.orders_count }}</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-title">Наличные</div>
                        <div class="summary-value">{{ branch_data.total_cash|format_price }}</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-title">Карта</div>
                        <div class="summary-value">{{ branch_data.total_card|format_price }}</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-title">Безнал</div>
                        <div class="summary-value">{{ branch_data.total_noname|format_price }}</div>
                    </div>

                    <div class="summary-card">
                        <div class="summary-title">Итого</div>
                        <div class="summary-value">{{ branch_data.total_amount|format_price }}</div>
                    </div>
                </div>
            </div>

            {% if branch_data.sold_items %}
                <div class="items-list">
                    <h3>Проданные товары</h3>
                    {% for item_name, item_data in branch_data.sold_items.items %}
                        <div class="item-entry">
                            <div class="item-info">
                                <div class="item-name">{{ item_name }}</div>
                                <div class="item-quantity">Продано за день: {{ item_data.quantity }} шт.</div>
                            </div>
                            <div class="payment-methods">
                                {% for method, amount in item_data.payment_methods.items %}
                                    <span class="method-item">
                                        {% if method == "Наличные (раздельно)" %}
                                            Наличные (разд.): {{ amount|format_price }}
                                        {% elif method == "Карта (раздельно)" %}
                                            Карта (разд.): {{ amount|format_price }}
                                        {% elif method == "Безналичный (раздельно)" %}
                                            Безнал (разд.): {{ amount|format_price }}
                                        {% else %}
                                            {{ method }}: {{ amount|format_price }}
                                        {% endif %}
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>Нет данных о проданных товарах.</p>
            {% endif %}

            <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">
        {% endfor %}

        {% if not branch_statistics %}
            <div class="no-orders">
                <p>Нет данных для отображения.</p>
            </div>
        {% endif %}
    </div>
</main>
{% endblock %}