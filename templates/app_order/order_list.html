{% extends 'base.html' %}
{% load static %}

{% block meta_description %}История заказов Solo Pizza - просмотрите все ваши заказы, их статусы и детали.{% endblock %}
{% block meta_keywords %}история заказов, список заказов, заказы пиццы, Solo Pizza заказы{% endblock %}
{% block og_description %}История заказов Solo Pizza - просмотрите все ваши заказы, их статусы и детали.{% endblock %}
{% block twitter_description %}История заказов Solo Pizza - просмотрите все ваши заказы, их статусы и детали.{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/order_list.css' %}">
{% endblock %}

{% block main %}
    <main class="order-list-page">
        {% if breadcrumbs %}
            <div class="breadcrumbs">
                {% for crumb in breadcrumbs %}
                    {% if crumb.url != '#' %}
                        <a href="{{ crumb.url }}" class="breadcrumb-link">{{ crumb.title }}</a>
                    {% else %}
                        <span class="breadcrumb-current">{{ crumb.title }}</span>
                    {% endif %}
                    {% if not forloop.last %}
                        <span class="breadcrumb-separator">›</span>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
        <div class="order-list-container">
            <h1 class="page-title">Мои заказы</h1>
            <div class="selected-branch-info">
                <div class="branch-display">
                    <p>Филиал: {{ selected_branch.name }}</p>
                    {% if request.user.is_staff %}
                    <button type="button" class="change-branch-btn" onclick="toggleBranchSelector()">Изменить филиал</button>
                    {% endif %}
                </div>
                {% if request.user.is_staff %}
                <div class="branch-selector" id="branchSelector" style="display: none;">
                    <form method="post" action="{% url 'app_home:select_branch' %}">
                        {% csrf_token %}
                        <select name="branch_id" class="branch-select">
                            {% for branch in branches %}
                                <option value="{{ branch.id }}" {% if branch.id|stringformat:"s" == selected_branch_id %}selected{% endif %}>
                                    {{ branch.name }} ({{ branch.address }})
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="apply-branch-btn">Применить</button>
                        <button type="button" class="cancel-branch-btn" onclick="toggleBranchSelector()">Отмена</button>
                    </form>
                </div>
                {% endif %}
            </div>

            <!-- Панель фильтров и поиска -->
            <div class="order-controls">
                <form method="get" class="search-form">
                    <div class="search-group">
                        <input type="text"
                               name="search"
                               placeholder="Поиск по ID, имени или телефону"
                               value="{{ search_query }}"
                               class="search-input">
                        <button type="submit" class="search-button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>

                    <div class="filter-group">
                        <select name="status" class="status-filter">
                            <option value="">Все статусы</option>
                            {% for status in status_choices %}
                                <option value="{{ status.0 }}"
                                        {% if status_filter == status.0 %}selected{% endif %}>
                                    {{ status.1 }}
                                </option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="filter-button">Применить</button>
                    </div>
                </form>
            </div>

            <!-- Таблица заказов -->
            <div class="orders-table">
                <div class="table-header">
                    <div class="header-cell">ID</div>
                    <div class="header-cell">Имя</div>
                    <div class="header-cell">Статус</div>
                    <div class="header-cell">Оплата</div>
                    {% if request.user.is_staff %}
                    <div class="header-cell">Филиал</div>
                    {% endif %}
                    <div class="header-cell">Детали</div>
                    {% if request.user.is_staff or request.user.is_superuser %}
                    <div class="header-cell">Чек</div>
                    <div class="header-cell">Фастфуд</div>
                    {% endif %}
                </div>

                {% for order in page_obj %}
                    <div class="table-row status-{{ order.status }}">
                        <div class="table-cell" data-label="ID">#{{ order.id }}</div>
                        <div class="table-cell" data-label="Имя">{{ order.customer_name }}</div>
                        <div class="table-cell" data-label="Статус">
                            {% if request.user.is_staff %}
                                <form method="post" action="{% url 'app_order:update_order_status' order.id %}">
                                    {% csrf_token %}
                                    <select name="status" class="status-select status-{{ order.status }}"
                                            onchange="this.form.submit()" required>
                                        {% for status in order.STATUS_CHOICES %}
                                            <option value="{{ status.0 }}"
                                                    {% if order.status == status.0 %}selected{% endif %}
                                                    {% if status.0 == 'canceled' %}data-confirm="true"{% endif %}>
                                                {{ status.1 }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </form>
                            {% else %}
                                <span class="status-badge {{ order.status }}">
                                    {{ order.get_status_display }}
                                </span>
                            {% endif %}
                        </div>
                        <div class="table-cell" data-label="Оплата">
                            {% if order.payment_status %}
                                <span class="payment-paid">Оплачено</span>
                            {% else %}
                                <span class="payment-unpaid">Не оплачено</span>
                            {% endif %}
                        </div>
                        {% if request.user.is_staff %}
                        <div class="table-cell" data-label="Филиал">
                            <div class="branch-info">
                                <span class="branch-name">{{ order.branch.name }}</span>
                                <button type="button" class="change-order-branch-btn" onclick="toggleOrderBranchSelector('order-branch-{{ order.id }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div id="order-branch-{{ order.id }}" class="order-branch-selector" style="display: none;">
                                <form method="post" action="{% url 'app_order:update_order_branch' order.id %}">
                                    {% csrf_token %}
                                    <select name="branch_id" class="branch-select">
                                        {% for branch in branches %}
                                            <option value="{{ branch.id }}" {% if branch.id == order.branch.id %}selected{% endif %}>
                                                {{ branch.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="branch-selector-buttons">
                                        <button type="submit" class="apply-branch-btn">OK</button>
                                        <button type="button" class="cancel-branch-btn" onclick="toggleOrderBranchSelector('order-branch-{{ order.id }}')">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        <div class="table-cell actions-cell" data-label="Детали">
                            <a href="{% url 'app_order:order_detail' order.id %}"
                               class="view-button"
                               title="Просмотреть">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                        {% if request.user.is_staff or request.user.is_superuser %}
                        <div class="table-cell" data-label="Чек">
                            <a href="{% url 'app_order:print_non_fastfood_check' order.id %}"
                               class="pdf-button"
                               title="Скачать чек">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </div>
                        <div class="table-cell" data-label="Фастфуд/Соусы/Бургеры">
                            <a href="{% url 'app_order:print_fastfood_check' order.id %}"
                               class="pdf-button"
                               title="Скачать чек фастфуда, соусов и бургеров">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>
                {% empty %}
                    <div class="no-orders">
                        <p>Заказы не найдены</p>
                    </div>
                {% endfor %}
            </div>

            <!-- Пагинация -->
            {% if page_obj.paginator.num_pages > 1 %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           class="page-link first-page">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                        <a href="?page=
                                {{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           class="page-link">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <span class="page-link current-page">{{ num }}</span>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <a href="?page=
                                    {{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                               class="page-link">
                                {{ num }}
                            </a>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <a href="?page=
                                {{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           class="page-link">
                            <i class="fas fa-angle-right"></i>
                        </a>
                        <a href="?page=
                                {{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
                           class="page-link last-page">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </main>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/order_list.js' %}"></script>
{% endblock %}
