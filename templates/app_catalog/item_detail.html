{% extends 'base.html' %}
{% load static %}

{% block meta_description %}{{ item.name }} - {{ item.description|default:"Вкусное блюдо от Solo Pizza" }}. Заказывайте с доставкой!{% endblock %}
{% block meta_keywords %}{{ item.name }}, заказать {{ item.name }}, доставка {{ item.name }}, {{ item.category.name }}, Solo Pizza{% endblock %}
{% block og_description %}{{ item.name }} - {{ item.description|default:"Вкусное блюдо от Solo Pizza" }}. Заказывайте с доставкой!{% endblock %}
{% block twitter_description %}{{ item.name }} - {{ item.description|default:"Вкусное блюдо от Solo Pizza" }}. Заказывайте с доставкой!{% endblock %}


{% block styles %}
    <link rel="stylesheet" href="{% static 'css/item_detail.css' %}">
{% endblock %}

{% block main %}
    <main>

        <section class="item">
        <div class="breadcrumbs">
            {% for crumb in breadcrumbs %}
                <a href="{{ crumb.url }}" class="breadcrumb-link">{{ crumb.title }}</a>
                {% if not forloop.last %}
                    <span class="breadcrumb-separator"> &gt; </span>
                {% endif %}
            {% endfor %}
        </div>
            <div class="item_container">
                {% if not user.is_staff and not user.is_superuser %}
                <div class="item-image">
                    {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}" class="item-image-border">
                    {% else %}
                        <img src="{% static 'img/No-Image-Placeholder.svg' %}" alt="{{ item.name }}" class="item-image-border">
                    {% endif %}
                </div>
                {% endif %}

                <div class="item-info">
                    <h1>{{ item.name }}</h1>
                    <p class="item-description">{{ item.description }}</p>

                    <!-- Цена -->
                    <div class="item-price" id="item-price">
                        {% if min_price %}
                            <span>Цена: {{ min_price }} руб.</span>
                        {% else %}
                            <span>Цена не указана</span>
                        {% endif %}
                    </div>

                    <!-- Размеры -->
                    <div class="form-group size-selector">
                        <h3>Выберите размер:</h3>
                        <div class="size-options">
                            {% for variant in variants %}
                                <button type="button" 
                                        class="size-option {% if selected_variant and selected_variant.id == variant.id %}selected{% endif %}"
                                        data-variant-id="{{ variant.id }}">
                                    {% if is_pizza_or_calzone and variant.size %}
                                        {{ variant.size.name }}
                                    {% elif variant.value %}
                                        {{ variant.value }} {{ variant.get_unit_display }}
                                    {% endif %}
                                </button>
                            {% empty %}
                                <span>Размеры не доступны</span>
                            {% endfor %}
                        </div>
                    </div>

                    <form method="POST" action="{% url 'app_cart:add_to_cart' item.slug %}" class="add-to-cart-form">
                        {% csrf_token %}

                        <!-- Размер -->
                        <input type="hidden" name="variant_id" id="variant_id" value="{{ selected_variant.id }}">

                        <!-- Количество -->
                        <div class="form-group">
                            <label for="quantity">Количество:</label>
                            <input type="number" id="quantity" name="quantity" value="1" min="1" max="10">
                        </div>

                        <!-- Соус -->
                        <div class="form-group option-selector{% if not sauces %} hidden{% endif %}" id="sauce-selector">
                            <h3>Выберите соус (один вариант):</h3>
                            <ul class="custom-radio-list" id="sauce-list">
                                {% for sauce in sauces %}
                                    <li>
                                        <label class="custom-radio">
                                            <input type="radio" name="sauce_id" value="{{ sauce.id }}"
                                                   {% if forloop.first %}checked{% endif %}
                                                   style="display: none;">
                                            <span class="radio-button"></span>
                                            {{ sauce.name }}
                                        </label>
                                    </li>
                                {% empty %}
                                    <li>Соусы не доступны</li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Борты -->
                        <div class="form-group board-selector{% if not boards %} hidden{% endif %}" id="board-selector">
                            <h3>Выберите борт:</h3>

                            <div class="board-pair">
                                <label for="board1">Первый борт:</label>
                                <select name="board1_id" id="board1" class="custom-select">
                                    <option value="">Не выбран</option>
                                    {% for board in boards %}
                                        <option value="{{ board.id }}">
                                            {{ board.board.name }} (+{{ board.price }} руб.)
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="board-pair">
                                <label for="board2">Второй борт:</label>
                                <select name="board2_id" id="board2" class="custom-select">
                                    <option value="">Не выбран</option>
                                    {% for board in boards %}
                                        <option value="{{ board.id }}">
                                            {{ board.board.name }} (+{{ board.price }} руб.)
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Добавки -->
                        <div class="form-group option-selector{% if not addons %} hidden{% endif %}" id="addon-selector">
                            <h3>Добавки (можно выбрать несколько):</h3>
                            <ul class="custom-checkbox-list" id="addon-list">
                                {% for addon in addons %}
                                    <li>
                                        <label class="custom-checkbox">
                                            <input type="checkbox" name="addons" value="{{ addon.id }}"
                                                   style="display: none;">
                                            <span class="checkbox-icon"></span>
                                            {{ addon.addon.name }} (+{{ addon.price }} руб.)
                                        </label>
                                    </li>
                                {% empty %}
                                    <li>Добавки не доступны</li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Напитки для комбо -->
                        <div class="form-group option-selector{% if not drinks %} hidden{% endif %}" id="drink-selector">
                            <h3>Выберите напиток (один вариант):</h3>
                            <ul class="custom-radio-list" id="drink-list">
                                {% for drink in drinks %}
                                    <li>
                                        <label class="custom-radio">
                                            <input type="radio" name="drink" value="{{ drink }}"
                                                   {% if forloop.first %}checked{% endif %}
                                                   style="display: none;">
                                            <span class="radio-button"></span>
                                            {{ drink }}
                                        </label>
                                    </li>
                                {% empty %}
                                    <li>Напитки не доступны</li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- Кнопка добавления в заказ -->
                        <button type="submit" class="order-link" id="add-to-cart-btn">Добавить в заказ</button>
                    </form>
                </div>
            </div>

        </section>
    </main>

<script>
// Категория товара для проверки доступности бортов
const itemCategory = '{{ item.category.name }}';
// Флаг обновления варианта, чтобы предотвратить отправку формы во время загрузки
let isVariantUpdating = false;

// Функция для динамического изменения размера товара
function changeSizeVariant(variantId) {
    const priceElement = document.getElementById('item-price');
    const variantInput = document.getElementById('variant_id');
    const submitBtn = document.getElementById('add-to-cart-btn');

    // 1) Немедленно обновляем скрытое поле с ID варианта (во избежание рассинхронизации при быстрой отправке формы)
    variantInput.value = variantId;

    // 2) Показываем индикатор загрузки и временно блокируем кнопку отправки
    priceElement.innerHTML = '<span>Загрузка...</span>';
    isVariantUpdating = true;
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.classList.add('disabled');
    }
    
    // 3) Отправляем AJAX запрос
    fetch(`/api/catalog/variant-data/${variantId}/`)
        .then(response => response.json())
        .then(data => {
            // Обновляем цену
            priceElement.innerHTML = `<span>Цена: ${data.price} руб.</span>`;
            
            // Обновляем соусы
            updateSauces(data.sauces);
            
            // Обновляем борты
            updateBoards(data.boards);
            
            // Обновляем добавки
            updateAddons(data.addons);
            
            // Обновляем напитки (для комбо)
            updateDrinks(data.drinks);
        })
        .catch(error => {
            console.error('Ошибка при загрузке данных варианта:', error);
            priceElement.innerHTML = '<span>Ошибка загрузки цены</span>';
        })
        .finally(() => {
            isVariantUpdating = false;
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.classList.remove('disabled');
            }
        });
}

// Функция обновления соусов
function updateSauces(sauces) {
    const sauceSelector = document.getElementById('sauce-selector');
    const sauceList = document.getElementById('sauce-list');
    
    // Проверяем категорию товара - соусы доступны только для пиццы и кальцоне
    const isPizzaOrCalzone = itemCategory === 'Пицца' || itemCategory === 'Кальцоне';
    
    if (sauces && sauces.length > 0 && isPizzaOrCalzone) {
        sauceSelector.classList.remove('hidden');
        sauceList.innerHTML = '';
        
        sauces.forEach((sauce, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <label class="custom-radio">
                    <input type="radio" name="sauce_id" value="${sauce.id}"
                           ${index === 0 ? 'checked' : ''}
                           style="display: none;">
                    <span class="radio-button"></span>
                    ${sauce.name}
                </label>
            `;
            sauceList.appendChild(li);
        });
    } else {
        sauceSelector.classList.add('hidden');
        sauceList.innerHTML = '';
    }
}

// Функция обновления бортов
function updateBoards(boards) {
    const boardSelector = document.getElementById('board-selector');
    const board1Select = document.getElementById('board1');
    const board2Select = document.getElementById('board2');
    
    // Проверяем категорию товара - борты доступны только для пиццы и комбо
    const isPizzaOrCombo = itemCategory === 'Пицца' || itemCategory === 'Комбо';
    
    if (boards && boards.length > 0 && isPizzaOrCombo) {
        boardSelector.classList.remove('hidden');
        
        // Очищаем селекты
        board1Select.innerHTML = '<option value="">Не выбран</option>';
        board2Select.innerHTML = '<option value="">Не выбран</option>';
        
        // Добавляем опции
        boards.forEach(board => {
            const option1 = document.createElement('option');
            option1.value = board.id;
            option1.textContent = `${board.name} (+${board.price} руб.)`;
            board1Select.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = board.id;
            option2.textContent = `${board.name} (+${board.price} руб.)`;
            board2Select.appendChild(option2);
        });
    } else {
        boardSelector.classList.add('hidden');
        board1Select.innerHTML = '<option value="">Не выбран</option>';
        board2Select.innerHTML = '<option value="">Не выбран</option>';
    }
}

// Функция обновления добавок
function updateAddons(addons) {
    const addonSelector = document.getElementById('addon-selector');
    const addonList = document.getElementById('addon-list');
    
    // Проверяем категорию товара - добавки доступны только для пиццы
    const isPizza = itemCategory === 'Пицца';
    
    if (addons && addons.length > 0 && isPizza) {
        addonSelector.classList.remove('hidden');
        addonList.innerHTML = '';
        
        addons.forEach(addon => {
            const li = document.createElement('li');
            li.innerHTML = `
                <label class="custom-checkbox">
                    <input type="checkbox" name="addons" value="${addon.id}"
                           id="id_addons_${addon.id}" style="display: none;">
                    <span class="checkbox-icon"></span>
                    ${addon.name} (+${addon.price} руб.)
                </label>
            `;
            addonList.appendChild(li);
        });
    } else {
        addonSelector.classList.add('hidden');
        addonList.innerHTML = '';
    }
}

// Функция обновления напитков
function updateDrinks(drinks) {
    const drinkSelector = document.getElementById('drink-selector');
    const drinkList = document.getElementById('drink-list');
    
    // Проверяем категорию товара - напитки доступны только для комбо
    const isCombo = itemCategory === 'Комбо';
    
    if (drinks && drinks.length > 0 && isCombo) {
        drinkSelector.classList.remove('hidden');
        drinkList.innerHTML = '';
        
        drinks.forEach((drink, index) => {
            const li = document.createElement('li');
            li.innerHTML = `
                <label class="custom-radio">
                    <input type="radio" name="drink" value="${drink}"
                           ${index === 0 ? 'checked' : ''}
                           style="display: none;">
                    <span class="radio-button"></span>
                    ${drink}
                </label>
            `;
            drinkList.appendChild(li);
        });
    } else {
        drinkSelector.classList.add('hidden');
        drinkList.innerHTML = '';
    }
}

// Добавляем обработчики событий для кнопок размеров
document.addEventListener('DOMContentLoaded', function() {
    const sizeButtons = document.querySelectorAll('.size-option');
    const form = document.querySelector('.add-to-cart-form');

    sizeButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Убираем класс selected у всех кнопок
            sizeButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Добавляем класс selected к нажатой кнопке
            this.classList.add('selected');
            
            // Получаем ID варианта и вызываем функцию изменения
            const variantId = this.getAttribute('data-variant-id');
            changeSizeVariant(variantId);
        });
    });

    // Блокируем отправку формы, если данные варианта ещё загружаются
    if (form) {
        form.addEventListener('submit', function(e) {
            if (isVariantUpdating) {
                e.preventDefault();
            }
        });
    }
});
</script>

{% endblock %}

