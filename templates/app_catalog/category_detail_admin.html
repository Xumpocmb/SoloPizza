{% extends 'base.html' %}
{% load static %}

{% block meta_description %}{{ category.name }} в Барановичах - {{ category.description|default:"Вкусные блюда с доставкой от Solo Pizza" }}. Закажите онлайн с доставкой по городу.{% endblock %}
{% block meta_keywords %}{{ category.name }} барановичи, заказать {{ category.name }} барановичи, доставка {{ category.name }} барановичи, {{ category.name }} с доставкой, Solo Pizza, заказать еду онлайн{% endblock %}
{% block og_description %}{{ category.name }} в Барановичах - {{ category.description|default:"Вкусные блюда с доставкой от Solo Pizza" }}. Закажите онлайн с доставкой по городу.{% endblock %}
{% block twitter_description %}{{ category.name }} в Барановичах - {{ category.description|default:"Вкусные блюда с доставкой от Solo Pizza" }}. Закажите онлайн с доставкой по городу.{% endblock %}
{% block schema_markup %}
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "ProductGroup",
  "name": "{{ category.name }}",
  "category": "{{ category.name }}",
  "description": "{{ category.description|default:"Вкусные блюда с доставкой от Solo Pizza" }}",
  "url": "{{ request.build_absolute_uri }}"
}
</script>
{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/catalog_admin.css' %}">
{% endblock %}

{% block main %}
    <main>
    <div class="main-wrapper">
        <div class="breadcrumbs">
            {% for crumb in breadcrumbs %}
                <a href="{{ crumb.url }}" class="breadcrumb-link">{{ crumb.title }}</a>
                {% if not forloop.last %}
                    <span class="breadcrumb-separator"> > </span>
                {% endif %}
            {% endfor %}
        </div>
        <section class="site-greetings">
            <div class="page_title">
                <h1>{{ category.name }} в Барановичах - Закажите с доставкой от Solo Pizza</h1>
            </div>
        </section>
        <section class="section_catalog">
            {% if items %}
                <div class="items-catalog-admin">
                    <!-- Компактная карточка товара для сотрудников с возможностью добавления в корзину -->
                    {% for item in items %}
                        <div class="item-card-admin">
                            <div class="item-info-admin">
                                <a href="{% url 'app_catalog:item_detail' item.slug %}">
                                    <h2>{{ item.name }}</h2>
                                </a>
                                <p>{{ item.description }}</p>
                            </div>
                            <div class="cart_price_section-admin">
                                <div class="item-price-admin">
                                    {% if item.min_price %}
                                        {{ item.min_price|floatformat:2 }} руб.
                                    {% else %}
                                        Цена не указана
                                    {% endif %}
                                </div>
                                <button class="toggle-form-btn" onclick="toggleForm('{{ item.slug }}')">В корзину</button>
                            </div>

                            <!-- Форма добавления в корзину -->
                            <form method="POST" action="{% url 'app_cart:add_to_cart' item.slug %}" class="add-to-cart-form-admin" id="add-to-cart-form-{{ item.slug }}">
                                {% csrf_token %}

                                <!-- Скрытое поле для хранения информации о параметрах товара -->
                                <input type="hidden" id="item-params-{{ item.slug }}"
                                       data-has-base-sauce="{{ item.has_base_sauce|yesno:'true,false' }}"
                                       data-has-border="{{ item.has_border|yesno:'true,false' }}"
                                       data-has-addons="{{ item.has_addons|yesno:'true,false' }}"
                                       data-has-drink="{{ item.has_drink|yesno:'true,false' }}"
                                       data-has-additional-sauces="{{ item.has_additional_sauces|yesno:'true,false' }}">

                                <!-- Размер -->
                                <div class="form-group-admin size-selector-admin">
                                    <h3>Выберите размер:</h3>
                                    <div class="size-options-admin">
                                        {% for variant in item.variants.all %}
                                            <button type="button"
                                                    class="size-option-admin {% if forloop.first %}selected{% endif %}"
                                                    data-variant-id="{{ variant.id }}"
                                                    data-item-slug="{{ item.slug }}"
                                                    data-item-category="{{ item.category.name }}">
                                                {% if item.category.name == 'Пицца' or item.category.name == 'Кальцоне' and variant.size %}
                                                    {{ variant.size.name }}
                                                {% elif variant.value %}
                                                    {{ variant.value }} {{ variant.get_unit_display }}
                                                {% endif %}
                                            </button>
                                        {% empty %}
                                            <span>Размеры не доступны</span>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="variant_id" id="variant_id_{{ item.slug }}" value="{% if item.variants.all %}{{ item.variants.first.id }}{% endif %}">
                                </div>
                                
                                <!-- Количество -->
                                <div class="form-group-admin">
                                    <label for="quantity_{{ item.slug }}">Количество:</label>
                                    <input type="number" id="quantity_{{ item.slug }}" name="quantity" value="1" min="1" max="10" class="quantity-input-admin">
                                </div>
                                
                                <!-- Соус -->
                                {% if item.has_base_sauce or item.has_additional_sauces %}
                                <div class="form-group-admin option-selector-admin hidden" id="sauce-selector-{{ item.slug }}">
                                    <h3>Выберите соус:</h3>
                                    <ul class="custom-radio-list-admin" id="sauce-list-{{ item.slug }}">
                                        <!-- Будет заполнено динамически -->
                                    </ul>
                                </div>
                                {% endif %}

                                <!-- Борты -->
                                {% if item.has_border %}
                                <div class="form-group-admin hidden" id="board-selector-{{ item.slug }}">
                                    <h3>Выберите борт:</h3>
                                    <div class="board-pair-admin">
                                        <label for="board1_{{ item.slug }}">Первый борт:</label>
                                        <select name="board1_id" id="board1_{{ item.slug }}" class="custom-select-admin">
                                            <option value="">Не выбран</option>
                                            <!-- Будет заполнено динамически -->
                                        </select>
                                    </div>
                                    <div class="board-pair-admin">
                                        <label for="board2_{{ item.slug }}">Второй борт:</label>
                                        <select name="board2_id" id="board2_{{ item.slug }}" class="custom-select-admin">
                                            <option value="">Не выбран</option>
                                            <!-- Будет заполнено динамически -->
                                        </select>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Добавки -->
                                {% if item.has_addons %}
                                <div class="form-group-admin option-selector-admin hidden" id="addon-selector-{{ item.slug }}">
                                    <h3>Добавки:</h3>
                                    <ul class="custom-checkbox-list-admin" id="addon-list-{{ item.slug }}">
                                        <!-- Будет заполнено динамически -->
                                    </ul>
                                </div>
                                {% endif %}

                                <!-- Напитки для комбо -->
                                {% if item.has_drink %}
                                <div class="form-group-admin option-selector-admin hidden" id="drink-selector-{{ item.slug }}">
                                    <h3>Напиток:</h3>
                                    <ul class="custom-radio-list-admin" id="drink-list-{{ item.slug }}">
                                        <!-- Будет заполнено динамически -->
                                    </ul>
                                </div>
                                {% endif %}
                                
                                <button type="submit" class="add-to-cart-btn-admin">Добавить в заказ</button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
                
                <script>
                    function toggleForm(itemSlug) {
                        const form = document.getElementById(`add-to-cart-form-${itemSlug}`);
                        form.classList.toggle('open');
                    }
                    
                    // Обработка изменения размера
                    document.querySelectorAll('.size-option-admin').forEach(button => {
                        button.addEventListener('click', function() {
                            const itemSlug = this.getAttribute('data-item-slug');
                            const itemCategory = this.getAttribute('data-item-category');
                            const variantId = this.getAttribute('data-variant-id');
                            
                            // Обновляем скрытое поле с ID варианта
                            document.getElementById(`variant_id_${itemSlug}`).value = variantId;
                            
                            // Обновляем выбранный размер
                            this.parentElement.querySelectorAll('.size-option-admin').forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            this.classList.add('selected');
                            
                            // Загружаем параметры для выбранного варианта
                            loadVariantData(itemSlug, variantId, itemCategory);
                        });
                    });
                    
                    // Функция загрузки данных варианта
                    function loadVariantData(itemSlug, variantId, itemCategory) {
                        fetch(`/catalog/variant-data/${variantId}/`)
                            .then(response => response.json())
                            .then(data => {
                                // Получаем информацию о параметрах товара из скрытого поля
                                const paramsInput = document.getElementById(`item-params-${itemSlug}`);
                                if (!paramsInput) {
                                    console.error(`Параметры для товара ${itemSlug} не найдены`);
                                    return;
                                }

                                const hasBaseSauce = paramsInput.dataset.hasBaseSauce === 'true';
                                const hasBorder = paramsInput.dataset.hasBorder === 'true';
                                const hasAddons = paramsInput.dataset.hasAddons === 'true';
                                const hasDrink = paramsInput.dataset.hasDrink === 'true';
                                const hasAdditionalSauces = paramsInput.dataset.hasAdditionalSauces === 'true';

                                updateSauces(itemSlug, data.sauces, hasBaseSauce || hasAdditionalSauces);
                                updateBoards(itemSlug, data.boards, hasBorder);
                                updateAddons(itemSlug, data.addons, hasAddons);
                                updateDrinks(itemSlug, data.drinks, hasDrink);
                            })
                            .catch(error => {
                                console.error('Ошибка при загрузке данных варианта:', error);
                            });
                    }

                    // Функция обновления соусов
                    function updateSauces(itemSlug, sauces, hasSauceOption) {
                        const sauceSelector = document.getElementById(`sauce-selector-${itemSlug}`);
                        // Проверяем, существует ли элемент (т.е. был ли показан в шаблоне)
                        if (!sauceSelector) return;

                        const sauceList = document.getElementById(`sauce-list-${itemSlug}`);

                        if (sauces && sauces.length > 0 && hasSauceOption) {
                            sauceSelector.classList.remove('hidden');
                            sauceList.innerHTML = '';

                            sauces.forEach((sauce, index) => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <label class="custom-radio">
                                        <input type="radio" name="sauce_id" value="${sauce.id}"
                                               ${index === 0 ? 'checked' : ''}
                                               style="display: none;">
                                        <span class="radio-button"></span>
                                        ${sauce.name}
                                    </label>
                                `;
                                sauceList.appendChild(li);
                            });
                        } else {
                            sauceSelector.classList.add('hidden');
                            sauceList.innerHTML = '';
                        }
                    }

                    // Функция обновления бортов
                    function updateBoards(itemSlug, boards, hasBorderOption) {
                        const boardSelector = document.getElementById(`board-selector-${itemSlug}`);
                        // Проверяем, существует ли элемент (т.е. был ли показан в шаблоне)
                        if (!boardSelector) return;

                        const board1Select = document.getElementById(`board1_${itemSlug}`);
                        const board2Select = document.getElementById(`board2_${itemSlug}`);

                        if (boards && boards.length > 0 && hasBorderOption) {
                            boardSelector.classList.remove('hidden');

                            // Очищаем селекты
                            board1Select.innerHTML = '<option value="">Не выбран</option>';
                            board2Select.innerHTML = '<option value="">Не выбран</option>';

                            // Добавляем опции
                            boards.forEach(board => {
                                const option1 = document.createElement('option');
                                option1.value = board.id;
                                option1.textContent = `${board.name} (+${board.price} руб.)`;
                                board1Select.appendChild(option1);

                                const option2 = document.createElement('option');
                                option2.value = board.id;
                                option2.textContent = `${board.name} (+${board.price} руб.)`;
                                board2Select.appendChild(option2);
                            });
                        } else {
                            boardSelector.classList.add('hidden');
                            board1Select.innerHTML = '<option value="">Не выбран</option>';
                            board2Select.innerHTML = '<option value="">Не выбран</option>';
                        }
                    }

                    // Функция обновления добавок
                    function updateAddons(itemSlug, addons, hasAddonsOption) {
                        const addonSelector = document.getElementById(`addon-selector-${itemSlug}`);
                        // Проверяем, существует ли элемент (т.е. был ли показан в шаблоне)
                        if (!addonSelector) return;

                        const addonList = document.getElementById(`addon-list-${itemSlug}`);

                        if (addons && addons.length > 0 && hasAddonsOption) {
                            addonSelector.classList.remove('hidden');
                            addonList.innerHTML = '';

                            addons.forEach(addon => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <label class="custom-checkbox">
                                        <input type="checkbox" name="addons" value="${addon.id}"
                                               id="id_addons_${addon.id}" style="display: none;">
                                        <span class="checkbox-icon"></span>
                                        ${addon.name} (+${addon.price} руб.)
                                    </label>
                                `;
                                addonList.appendChild(li);
                            });
                        } else {
                            addonSelector.classList.add('hidden');
                            addonList.innerHTML = '';
                        }
                    }

                    // Функция обновления напитков
                    function updateDrinks(itemSlug, drinks, hasDrinkOption) {
                        const drinkSelector = document.getElementById(`drink-selector-${itemSlug}`);
                        // Проверяем, существует ли элемент (т.е. был ли показан в шаблоне)
                        if (!drinkSelector) return;

                        const drinkList = document.getElementById(`drink-list-${itemSlug}`);

                        if (drinks && drinks.length > 0 && hasDrinkOption) {
                            drinkSelector.classList.remove('hidden');
                            drinkList.innerHTML = '';

                            drinks.forEach((drink, index) => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <label class="custom-radio">
                                        <input type="radio" name="drink" value="${drink.name}"
                                               ${index === 0 ? 'checked' : ''}
                                               style="display: none;">
                                        <span class="radio-button"></span>
                                        ${drink.name}
                                    </label>
                                `;
                                drinkList.appendChild(li);
                            });
                        } else {
                            drinkSelector.classList.add('hidden');
                            drinkList.innerHTML = '';
                        }
                    }

                    // Инициализируем параметры для первого варианта каждого товара при загрузке страницы
                    document.addEventListener('DOMContentLoaded', function() {
                        document.querySelectorAll('.size-option-admin.selected').forEach(button => {
                            if(button.hasAttribute('data-variant-id')) {
                                const itemSlug = button.getAttribute('data-item-slug');
                                const itemCategory = button.getAttribute('data-item-category');
                                const variantId = button.getAttribute('data-variant-id');
                                loadVariantData(itemSlug, variantId, itemCategory);
                            }
                        });
                    });
                </script>
            {% else %}
                <div class="page_title">
                    <h3>Упс.. Мы еще ничего не приготовили..</h3>
                </div>
            {% endif %}

        </section>
    </div>
    </main>
{% endblock %}
